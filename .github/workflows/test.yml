name: ğŸ§ª Test & Security Scan

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # Code Quality & Testing
  # ============================================================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        cd frontend && npm ci

    - name: ğŸ§¹ Lint Code
      run: |
        echo "ğŸ” Running ESLint..."
        cd frontend && npm run lint

    - name: ğŸ”§ Type Check
      run: |
        echo "ğŸ” Running TypeScript compiler..."
        cd frontend && npm run type-check

    - name: ğŸ§ª Run Unit Tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        cd frontend && npm run test -- --coverage
      env:
        CI: true

    - name: ğŸ“Š Upload Coverage to Codecov
      if: matrix.node-version == 18
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: codecov-umbrella

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        cd frontend && npm ci

    - name: ğŸ” NPM Audit
      run: |
        echo "ğŸ”’ Running NPM security audit..."
        npm audit --audit-level moderate || echo "Security vulnerabilities found"
        cd frontend && npm audit --audit-level moderate || echo "Frontend security vulnerabilities found"

    - name: ğŸ” CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript, typescript

    - name: ğŸ—ï¸ Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

    - name: ğŸ”’ Snyk Security Scan
      if: env.SNYK_TOKEN
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium

  # ============================================================================
  # Dependency Review
  # ============================================================================
  dependency-review:
    name: ğŸ“¦ Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  # ============================================================================
  # Performance Testing
  # ============================================================================
  performance:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies & Build
      run: |
        npm ci
        cd frontend && npm ci && npm run build

    - name: âš¡ Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

  # ============================================================================
  # Accessibility Testing
  # ============================================================================
  accessibility:
    name: â™¿ Accessibility Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        cd frontend && npm ci

    - name: ğŸ—ï¸ Build Application
      run: |
        cd frontend && npm run build

    - name: â™¿ Run Pa11y Accessibility Tests
      run: |
        npx pa11y-ci --sitemap http://localhost:4173/sitemap.xml || echo "Accessibility issues found"

  # ============================================================================
  # Browser Testing
  # ============================================================================
  browser-test:
    name: ğŸŒ Browser Compatibility Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    strategy:
      matrix:
        browser: [chrome, firefox, safari]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        cd frontend && npm ci

    - name: ğŸŒ Install Playwright
      run: |
        cd frontend && npx playwright install --with-deps ${{ matrix.browser }}

    - name: ğŸ§ª Run Browser Tests
      run: |
        cd frontend && npx playwright test --browser=${{ matrix.browser }}

    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-results-${{ matrix.browser }}
        path: frontend/test-results
        retention-days: 30

  # ============================================================================
  # Medical Content Validation
  # ============================================================================
  medical-validation:
    name: ğŸ¥ Medical Content Validation
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[medical]') || github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ¥ Validate Medical Terms
      run: |
        echo "ğŸ¥ Validating medical terminology and content..."
        node scripts/validate-medical-content.js
      env:
        MEDICAL_TERMS_API: ${{ secrets.MEDICAL_TERMS_API }}

  # ============================================================================
  # Notification Summary
  # ============================================================================
  test-summary:
    name: ğŸ“Š Test Summary
    needs: [test, security, dependency-review, performance, accessibility]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Test Summary
      run: |
        echo "ğŸ“Š Test Summary for ${{ github.sha }}"
        echo "=================================="
        echo "âœ… Code Quality: ${{ needs.test.result }}"
        echo "ğŸ”’ Security Scan: ${{ needs.security.result }}"
        echo "ğŸ“¦ Dependencies: ${{ needs.dependency-review.result }}"
        echo "âš¡ Performance: ${{ needs.performance.result }}"
        echo "â™¿ Accessibility: ${{ needs.accessibility.result }}"
        
        if [[ "${{ needs.test.result }}" == "success" && 
              "${{ needs.security.result }}" == "success" ]]; then
          echo "ğŸ‰ All critical tests passed!"
        else
          echo "âŒ Some tests failed - review required"
          exit 1
        fi

    - name: ğŸ“¢ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const testResults = {
            test: '${{ needs.test.result }}',
            security: '${{ needs.security.result }}',
            dependencies: '${{ needs.dependency-review.result }}',
            performance: '${{ needs.performance.result }}',
            accessibility: '${{ needs.accessibility.result }}'
          };
          
          const getEmoji = (result) => {
            switch(result) {
              case 'success': return 'âœ…';
              case 'failure': return 'âŒ';
              case 'skipped': return 'â­ï¸';
              default: return 'âš ï¸';
            }
          };
          
          const body = `## ğŸ§ª Test Results Summary
          
          | Test Type | Status | Result |
          |-----------|--------|---------|
          | Code Quality | ${getEmoji(testResults.test)} | ${testResults.test} |
          | Security Scan | ${getEmoji(testResults.security)} | ${testResults.security} |
          | Dependencies | ${getEmoji(testResults.dependencies)} | ${testResults.dependencies} |
          | Performance | ${getEmoji(testResults.performance)} | ${testResults.performance} |
          | Accessibility | ${getEmoji(testResults.accessibility)} | ${testResults.accessibility} |
          
          ---
          ğŸ¤– *Automated test report for commit ${{ github.sha }}*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
