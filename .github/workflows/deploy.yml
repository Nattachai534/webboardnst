name: ğŸš€ Deploy Nursing Webboard

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual deployment

# Permissions needed for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  VITE_APP_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

jobs:
  # ============================================================================
  # Build Job
  # ============================================================================
  build:
    name: ğŸ”§ Build Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better caching

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          frontend/package-lock.json

    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ” Installing root dependencies..."
        npm ci
        echo "ğŸ” Installing frontend dependencies..."
        cd frontend && npm ci

    - name: ğŸ” Setup Environment Variables
      run: |
        echo "ğŸ”§ Setting up environment variables..."
        
        # Create .env.local file for build
        cat > frontend/.env.local << EOF
        VITE_APP_ENV=${{ env.VITE_APP_ENV }}
        VITE_APP_VERSION=${{ github.sha }}
        VITE_APP_NAME=EduNursing Board
        VITE_APP_URL=${{ vars.APP_URL || 'https://your-username.github.io/nursing-webboard' }}
        VITE_GOOGLE_SHEETS_API_URL=${{ secrets.GOOGLE_SHEETS_API_URL }}
        VITE_RECAPTCHA_SITE_KEY=${{ secrets.RECAPTCHA_SITE_KEY }}
        VITE_GA_MEASUREMENT_ID=${{ secrets.GA_MEASUREMENT_ID }}
        VITE_SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        VITE_DEBUG=${{ env.VITE_APP_ENV == 'production' && 'false' || 'true' }}
        FEATURE_OFFLINE_MODE=true
        FEATURE_AUTO_BACKUP=true
        EOF

    - name: ğŸ§ª Run Type Checking
      run: |
        echo "ğŸ” Running TypeScript type checking..."
        cd frontend && npm run type-check

    - name: ğŸ§¹ Run Linting
      run: |
        echo "ğŸ” Running ESLint..."
        cd frontend && npm run lint

    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running test suite..."
        cd frontend && npm run test
      env:
        CI: true

    - name: ğŸ—ï¸ Build Application
      run: |
        echo "ğŸ”¨ Building application for ${{ env.VITE_APP_ENV }}..."
        cd frontend && npm run build
        
        # Add build info
        echo "Build: $(date)" > dist/build-info.txt
        echo "Commit: ${{ github.sha }}" >> dist/build-info.txt
        echo "Environment: ${{ env.VITE_APP_ENV }}" >> dist/build-info.txt

    - name: ğŸ“Š Bundle Analysis (if enabled)
      if: env.VITE_APP_ENV == 'production'
      run: |
        echo "ğŸ“Š Analyzing bundle size..."
        cd frontend && npm run analyze || echo "Bundle analysis not available"

    - name: ğŸ” Security Scan
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level moderate || echo "Security issues found - review required"

    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-pages-artifact@v2
      with:
        path: frontend/dist

    - name: ğŸ“¤ Upload Coverage Reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: frontend/coverage
        retention-days: 30

  # ============================================================================
  # Deploy to GitHub Pages
  # ============================================================================
  deploy-pages:
    name: ğŸŒ Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # ============================================================================
  # Deploy to Vercel (Alternative)
  # ============================================================================
  deploy-vercel:
    name: â–² Deploy to Vercel
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && vars.DEPLOY_TO_VERCEL == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â–² Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'

  # ============================================================================
  # Deploy to Netlify (Alternative)
  # ============================================================================
  deploy-netlify:
    name: ğŸŒŠ Deploy to Netlify
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && vars.DEPLOY_TO_NETLIFY == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies & Build
      run: |
        npm ci
        cd frontend && npm ci && npm run build

    - name: ğŸŒŠ Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.1
      with:
        publish-dir: './frontend/dist'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
        enable-pull-request-comment: true
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ============================================================================
  # Notification Job
  # ============================================================================
  notify:
    name: ğŸ“¢ Send Notifications
    needs: [build, deploy-pages]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¢ Slack Notification
      if: secrets.SLACK_WEBHOOK_URL
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#nursing-webboard'
        username: 'GitHub Actions'
        icon_emoji: ':rocket:'
        title: 'Nursing Webboard Deployment'
        message: |
          ğŸ¥ Nursing Webboard has been deployed!
          
          ğŸ“‹ **Details:**
          â€¢ Environment: ${{ env.VITE_APP_ENV }}
          â€¢ Commit: `${{ github.sha }}`
          â€¢ Actor: ${{ github.actor }}
          â€¢ Status: ${{ job.status }}
          
          ğŸ”— **Links:**
          â€¢ [ğŸŒ Live Site](${{ vars.APP_URL }})
          â€¢ [ğŸ“ Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          â€¢ [ğŸ”§ Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # Backup Job (if enabled)
  # ============================================================================
  backup:
    name: ğŸ’¾ Backup Data
    needs: deploy-pages
    runs-on: ubuntu-latest
    if: success() && vars.ENABLE_AUTO_BACKUP == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ’¾ Run Backup Script
      run: |
        echo "ğŸ’¾ Running automated backup..."
        npm install
        node scripts/backup-sheets.js
      env:
        GOOGLE_SHEETS_API_URL: ${{ secrets.GOOGLE_SHEETS_API_URL }}
        BACKUP_STORAGE_TYPE: ${{ vars.BACKUP_STORAGE_TYPE || 'local' }}

    - name: ğŸ“¤ Upload Backup
      uses: actions/upload-artifact@v3
      with:
        name: backup-${{ github.sha }}
        path: backups/
        retention-days: 90
